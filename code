#include <Adafruit_GFX.h>
#include <Adafruit_ILI9341.h>
#include <SPI.h>
#include <EEPROM.h>

// ===== TFT Pins =====
#define TFT_CS    10
#define TFT_DC     9
#define TFT_RST    8
Adafruit_ILI9341 tft = Adafruit_ILI9341(TFT_CS, TFT_DC, TFT_RST);

// ===== Input Pins =====
#define VSS_PIN    2
#define BTN_PIN    3
#define LED_PIN    4

// ===== Analog Pins =====
#define MAP_PIN    A0
#define IAT_PIN    A1
#define OIL_PIN    A2
#define FUEL_PIN   A3

// ===== Calibration Constants =====
#define OIL_ZERO_ADC 102
#define OIL_FULL_ADC 921
#define OIL_MAX_PSI 100.0

#define MAP_ZERO_ADC 102
#define MAP_FULL_ADC 921
#define MAP_MIN_KPA 50.0
#define MAP_MAX_KPA 400.0
float ambient_kPa = 101.0;

int fuelEmptyADC = 614;
int fuelFullADC  = 82;

const float R_PULL = 10000.0;
const double A_coef = 0.00129, B_coef = 0.000266, C_coef = 0.000000122;

// ===== Speed & Trip Tracking =====
volatile unsigned long pulseCount = 0;
unsigned long tripPulseCount = 0;
unsigned long lastSavedPulseCount = 0;
unsigned long lastSpeedMillis = 0;
const unsigned long speedInterval = 500;  // ms
const int EEPROM_ADDR = 0;

// ===== Button Debounce =====
bool lastButtonState = HIGH;
unsigned long lastDebounceTime = 0;
const unsigned long debounceDelay = 50;

// ===== Startup LED Timing =====
unsigned long startTime;

void onVSSPulse() {
  pulseCount++;
  tripPulseCount++;
}

void setup() {
  Serial.begin(9600);
  
  pinMode(VSS_PIN, INPUT_PULLUP);
  pinMode(BTN_PIN, INPUT_PULLUP);
  pinMode(LED_PIN, OUTPUT);
  attachInterrupt(digitalPinToInterrupt(VSS_PIN), onVSSPulse, FALLING);

  EEPROM.get(EEPROM_ADDR, tripPulseCount);
  lastSavedPulseCount = tripPulseCount;

  digitalWrite(LED_PIN, HIGH);
  startTime = millis();

  tft.begin();
  tft.setRotation(1);
  tft.fillScreen(ILI9341_BLACK);
  tft.setTextSize(2);
  tft.setTextColor(ILI9341_WHITE, ILI9341_BLACK);

  // Ambient pressure read at key-on
  int raw = analogRead(MAP_PIN);
  float pressure_kPa = (raw - MAP_ZERO_ADC) * (MAP_MAX_KPA - MAP_MIN_KPA) / (MAP_FULL_ADC - MAP_ZERO_ADC) + MAP_MIN_KPA;
  if (pressure_kPa > 80 && pressure_kPa < 120) ambient_kPa = pressure_kPa;
}

void loop() {
  unsigned long now = millis();
  if (now - startTime >= 4000) digitalWrite(LED_PIN, LOW);

  if (now - lastSpeedMillis >= speedInterval) {
    noInterrupts();
    unsigned long pulses = pulseCount;
    pulseCount = 0;
    interrupts();

    float mph = pulses * (1000.0 / speedInterval) * 0.45;
    float tripMiles = tripPulseCount / 8000.0;

    int rawOil = analogRead(OIL_PIN);
    float oilPsi = (rawOil - OIL_ZERO_ADC) * (OIL_MAX_PSI / (OIL_FULL_ADC - OIL_ZERO_ADC));
    if (oilPsi < 0) oilPsi = 0;

    int rawFuel = analogRead(FUEL_PIN);
    int fuelPercent = map(rawFuel, fuelFullADC, fuelEmptyADC, 100, 0);
    fuelPercent = constrain(fuelPercent, 0, 100);

    int rawMAP = analogRead(MAP_PIN);
    float pressure_kPa = (rawMAP - MAP_ZERO_ADC) * (MAP_MAX_KPA - MAP_MIN_KPA) / (MAP_FULL_ADC - MAP_ZERO_ADC) + MAP_MIN_KPA;
    float boost_kPa = pressure_kPa - ambient_kPa;
    if (boost_kPa < 0) boost_kPa = 0;
    float boostPsi = boost_kPa / 6.89476;

    int rawIAT = analogRead(IAT_PIN);
    float Vout = rawIAT * (5.0 / 1023.0);
    float Rth = R_PULL * (Vout / (5.0 - Vout));
    double lnR = log(Rth);
    double invT = A_coef + B_coef * lnR + C_coef * pow(lnR, 3);
    double tempK = 1.0 / invT;
    double tempF = (tempK - 273.15) * 9.0 / 5.0 + 32.0;

    // Display Output
    tft.setCursor(10, 10);
    tft.printf("SPD: %3d MPH", (int)round(mph));
    tft.setCursor(10, 40);
    tft.printf("BST: %.1f PSI", boostPsi);
    tft.setCursor(10, 70);
    tft.printf("IAT: %3d F", (int)round(tempF));
    tft.setCursor(10, 100);
    tft.printf("OIL: %3d PSI", (int)round(oilPsi));
    tft.setCursor(10, 130);
    tft.printf("FUEL: %3d%%", fuelPercent);
    tft.setCursor(10, 160);
    tft.printf("TRIP: %.1f mi", tripMiles);

    // EEPROM save
    if (tripPulseCount >= lastSavedPulseCount + 800) {
      EEPROM.put(EEPROM_ADDR, tripPulseCount);
      lastSavedPulseCount = tripPulseCount;
    }

    lastSpeedMillis = now;
  }

  // Button debounce for trip reset
  int reading = digitalRead(BTN_PIN);
  if (reading != lastButtonState) {
    lastDebounceTime = millis();
    lastButtonState = reading;
  }
  if ((millis() - lastDebounceTime) > debounceDelay && lastButtonState == LOW) {
    tripPulseCount = 0;
    EEPROM.put(EEPROM_ADDR, 0);
    lastSavedPulseCount = 0;
  }
}
